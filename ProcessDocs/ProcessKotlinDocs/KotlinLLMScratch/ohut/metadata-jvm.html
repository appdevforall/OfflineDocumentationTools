<html>
 <head>
  <meta charset="utf-8"/>
  <title>
   Kotlin Documentation
  </title>
  <link href="style.css" rel="stylesheet"/>
 </head>
 <body>
  <div style="text-align: center; margin-bottom: 1em;">
   <a href="toc.html" style="font-size: 24px; text-decoration: none;">
    Menu
   </a>
  </div>
  <article class="article" data-shortcut-switcher="inactive">
   <h1 data-label-id="advanced" data-toc="metadata-jvm" id="metadata-jvm.md">
    Kotlin Metadata JVM library
   </h1>
   <p id="-msity5_3">
    The
    <a data-external="true" href="https://github.com/JetBrains/kotlin/tree/master/libraries/kotlinx-metadata/jvm" id="-msity5_11" rel="noopener noreferrer" style="color: red;" target="_blank">
     <code class="code" id="-msity5_15">
      kotlin-metadata-jvm
     </code>
    </a>
    library provides tools to read, modify, and generate metadata from Kotlin classes compiled for the JVM. This metadata, stored in the
    <a data-external="true" href="https://kotlinlang.org/api/core/kotlin-stdlib/kotlin/-metadata/" id="-msity5_12" rel="noopener noreferrer" style="color: red;" target="_blank">
     <code class="code" id="-msity5_16">
      @Metadata
     </code>
    </a>
    annotation within
    <code class="code" id="-msity5_13">
     .class
    </code>
    files, is used by libraries and tools such as
    <a data-tooltip="Reflection is a set of language and library features that allows you to introspect the structure of your program at runtime. Functions and properties are first-class citizens in Kotlin, and the ability to introspect them (for example, learning the name or the type of a property orâ€¦" href="reflection.html" id="-msity5_14" style="color: blue;">
     <code class="code" id="-msity5_17">
      kotlin-reflect
     </code>
    </a>
    to inspect Kotlin-specific constructs such as properties, functions, and classes at runtime.
   </p>
   <aside class="prompt" data-title="" data-type="warning" id="-msity5_4">
    <p id="-msity5_18">
     The
     <code class="code" id="-msity5_19">
      kotlin-reflect
     </code>
     library relies on metadata to retrieve Kotlin-specific class details at runtime. Any inconsistencies between the metadata and the actual
     <code class="code" id="-msity5_20">
      .class
     </code>
     file may lead to incorrect behavior when using reflection.
    </p>
   </aside>
   <p id="-msity5_5">
    You can also use the Kotlin Metadata JVM library to inspect various declaration attributes such as visibility or modality, or to generate and embed metadata into
    <code class="code" id="-msity5_21">
     .class
    </code>
    files.
   </p>
   <section class="chapter">
    <h2 data-toc="add-the-library-to-your-project" id="add-the-library-to-your-project">
     Add the library to your project
    </h2>
    <p id="-msity5_22">
     To include the Kotlin Metadata JVM library in your project, add the corresponding dependency configuration based on your build tool.
    </p>
    <aside class="prompt" data-title="" data-type="note" id="-msity5_23">
     <p id="-msity5_26">
      The Kotlin Metadata JVM library follows the same versioning as the Kotlin compiler and standard library. Ensure that the version you use matches your project's Kotlin version.
     </p>
    </aside>
    <section class="chapter">
     <h3 data-toc="gradle" id="gradle">
      Gradle
     </h3>
     <p id="-msity5_27">
      Add the following dependency to your
      <code class="code" id="-msity5_29">
       build.gradle(.kts)
      </code>
      file:
     </p>
     <div class="tabs" data-anchors="[-msity5_30,-msity5_31]" data-group="build-tool" id="-msity5_28">
      <div class="tabs__content" data-gtm="tab" data-sync-tabs="kotlin" data-title="Kotlin" id="-msity5_30">
       <div class="code-block" data-lang="kotlin" data-title="Kotlin" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
        // build.gradle.kts
repositories {
    mavenCentral()
}

dependencies {
    implementation("org.jetbrains.kotlin:kotlin-metadata-jvm:2.1.20")
}
       </div>
      </div>
      <div class="tabs__content" data-gtm="tab" data-sync-tabs="groovy" data-title="Groovy" id="-msity5_31">
       <div class="code-block" data-lang="groovy" data-title="Groovy" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
        // build.gradle
repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.jetbrains.kotlin:kotlin-metadata-jvm:2.1.20'
}
       </div>
      </div>
     </div>
    </section>
    <section class="chapter">
     <h3 data-toc="maven" id="maven">
      Maven
     </h3>
     <p id="-msity5_34">
      Add the following dependency to your
      <code class="code" id="-msity5_36">
       pom.xml
      </code>
      file.
     </p>
     <div class="code-block" data-lang="markup" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
      &lt;project&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;
            &lt;artifactId&gt;kotlin-metadata-jvm&lt;/artifactId&gt;
            &lt;version&gt;2.1.20&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    ...
&lt;/project&gt;
     </div>
    </section>
   </section>
   <section class="chapter">
    <h2 data-toc="read-and-parse-metadata" id="read-and-parse-metadata">
     Read and parse metadata
    </h2>
    <p id="-msity5_37">
     The
     <code class="code" id="-msity5_46">
      kotlin-metadata-jvm
     </code>
     library extracts structured information from compiled Kotlin
     <code class="code" id="-msity5_47">
      .class
     </code>
     files, such as class names, visibility, and signatures. You can use it in projects that need to analyze compiled Kotlin declarations. For example, the
     <a data-external="true" href="https://github.com/Kotlin/binary-compatibility-validator" id="-msity5_48" rel="noopener noreferrer" style="color: red;" target="_blank">
      Binary Compatibility Validator (BCV)
     </a>
     relies on
     <code class="code" id="-msity5_49">
      kotlin-metadata-jvm
     </code>
     to print public API declarations.
    </p>
    <p id="-msity5_38">
     You can start exploring Kotlin class metadata by retrieving the
     <code class="code" id="-msity5_50">
      @Metadata
     </code>
     annotation from a compiled class using reflection:
    </p>
    <div class="code-block" data-lang="kotlin" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
     fun main() {
    // Specifies the fully qualified name of the class
    val clazz = Class.forName("org.example.SampleClass")

    // Retrieves the @Metadata annotation
    val metadata = clazz.getAnnotation(Metadata::class.java)

    // Checks if the metadata is present
    if (metadata != null) {
        println("This is a Kotlin class with metadata.")
    } else {
        println("This is not a Kotlin class.")
    }
}
    </div>
    <p id="-msity5_40">
     After retrieving the
     <code class="code" id="-msity5_51">
      @Metadata
     </code>
     annotation, use either the
     <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/kotlin-metadata-jvm/kotlin.metadata.jvm/-kotlin-class-metadata/-companion/read-lenient.html" id="-msity5_52" rel="noopener noreferrer" style="color: red;" target="_blank">
      <code class="code" id="-msity5_55">
       readLenient()
      </code>
     </a>
     or the
     <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/kotlin-metadata-jvm/kotlin.metadata.jvm/-kotlin-class-metadata/-companion/read-strict.html" id="-msity5_53" rel="noopener noreferrer" style="color: red;" target="_blank">
      <code class="code" id="-msity5_56">
       readStrict()
      </code>
     </a>
     function from the
     <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/kotlin-metadata-jvm/kotlin.metadata.jvm/-kotlin-class-metadata/" id="-msity5_54" rel="noopener noreferrer" style="color: red;" target="_blank">
      <code class="code" id="-msity5_57">
       KotlinClassMetadata
      </code>
     </a>
     API to parse it. These functions extract detailed information about classes or files, while addressing different compatibility requirements:
    </p>
    <ul class="list _bullet" id="-msity5_41">
     <li class="list__item" id="-msity5_58">
      <p id="-msity5_60">
       <code class="code" id="-msity5_61">
        readLenient()
       </code>
       : Use this function to read metadata, including metadata generated by newer Kotlin compiler versions. This function doesn't support modifying or writing metadata.
      </p>
     </li>
     <li class="list__item" id="-msity5_59">
      <p id="-msity5_62">
       <code class="code" id="-msity5_65">
        readStrict()
       </code>
       : Use this function when you need to modify and write metadata. The
       <code class="code" id="-msity5_66">
        readStrict()
       </code>
       function only works with metadata generated by Kotlin compiler versions fully supported by your project.
      </p>
      <aside class="prompt" data-title="" data-type="note" id="-msity5_63">
       <p id="-msity5_67">
        The
        <code class="code" id="-msity5_69">
         readStrict()
        </code>
        function supports metadata formats up to one version beyond
        <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/kotlin-metadata-jvm/kotlin.metadata.jvm/-jvm-metadata-version/-companion/-l-a-t-e-s-t_-s-t-a-b-l-e_-s-u-p-p-o-r-t-e-d.html" id="-msity5_70" rel="noopener noreferrer" style="color: red;" target="_blank">
         <code class="code" id="-msity5_74">
          JvmMetadataVersion.LATEST_STABLE_SUPPORTED
         </code>
        </a>
        , which corresponds to the latest Kotlin version used in the project. For example, if your project depends on
        <code class="code" id="-msity5_71">
         kotlin-metadata-jvm:2.1.0
        </code>
        ,
        <code class="code" id="-msity5_72">
         readStrict()
        </code>
        can process metadata up to Kotlin
        <code class="code" id="-msity5_73">
         2.2.x
        </code>
        ; otherwise, it throws an error to prevent mishandling unknown formats.
       </p>
       <p id="-msity5_68">
        For more information, see the
        <a data-external="true" href="https://github.com/JetBrains/kotlin/blob/master/libraries/kotlinx-metadata/jvm/ReadMe.md#detailed-explanation" id="-msity5_75" rel="noopener noreferrer" style="color: red;" target="_blank">
         Kotlin Metadata GitHub repository
        </a>
        .
       </p>
      </aside>
      <p id="-msity5_64">
      </p>
     </li>
    </ul>
    <p id="-msity5_42">
     When parsing metadata, the
     <code class="code" id="-msity5_76">
      KotlinClassMetadata
     </code>
     instance provides structured information about class or file-level declarations. For classes, use the
     <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/kotlin-metadata-jvm/kotlin.metadata.jvm/-kotlin-class-metadata/-class/km-class.html" id="-msity5_77" rel="noopener noreferrer" style="color: red;" target="_blank">
      <code class="code" id="-msity5_79">
       kmClass
      </code>
     </a>
     property to analyze detailed class-level metadata, such as the class name, functions, properties, and attributes like visibility. For file-level declarations, the metadata is represented by the
     <code class="code" id="-msity5_78">
      kmPackage
     </code>
     property, which includes top-level functions and properties from file facades generated by the Kotlin compiler.
    </p>
    <p id="-msity5_43">
     The following code example demonstrates how to use
     <code class="code" id="-msity5_80">
      readLenient()
     </code>
     to parse metadata, analyze class-level details with
     <code class="code" id="-msity5_81">
      kmClass
     </code>
     , and retrieve file-level declarations with
     <code class="code" id="-msity5_82">
      kmPackage
     </code>
     :
    </p>
    <div class="code-block" data-lang="kotlin" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
     // Imports the necessary libraries
import kotlin.metadata.jvm.*
import kotlin.metadata.*

fun main() {
    // Specifies the fully qualified class name
    val className = "org.example.SampleClass"

    try {
        // Retrieves the class object for the specified name
        val clazz = Class.forName(className)

        // Retrieves the @Metadata annotation
        val metadataAnnotation = clazz.getAnnotation(Metadata::class.java)
        if (metadataAnnotation != null) {
            println("Kotlin Metadata found for class: $className")

            // Parses metadata using the readLenient() function
            val metadata = KotlinClassMetadata.readLenient(metadataAnnotation)
            when (metadata) {
                is KotlinClassMetadata.Class -&gt; {
                    val kmClass = metadata.kmClass
                    println("Class name: ${kmClass.name}")

                    // Iterates over functions and checks visibility
                    kmClass.functions.forEach { function -&gt;
                        val visibility = function.visibility
                        println("Function: ${function.name}, Visibility: $visibility")
                    }
                }
                is KotlinClassMetadata.FileFacade -&gt; {
                    val kmPackage = metadata.kmPackage

                    // Iterates over functions and checks visibility
                    kmPackage.functions.forEach { function -&gt;
                        val visibility = function.visibility
                        println("Function: ${function.name}, Visibility: $visibility")
                    }
                }
                else -&gt; {
                    println("Unsupported metadata type: $metadata")
                }
            }
        } else {
            println("No Kotlin Metadata found for class: $className")
        }
    } catch (e: ClassNotFoundException) {
        println("Class not found: $className")
    } catch (e: Exception) {
        println("Error processing metadata: ${e.message}")
        e.printStackTrace()
    }
}
    </div>
    <section class="chapter">
     <h3 data-toc="extract-metadata-from-bytecode" id="extract-metadata-from-bytecode">
      Extract metadata from bytecode
     </h3>
     <p id="-msity5_83">
      While you can retrieve metadata using reflection, another approach is to extract it from bytecode using a bytecode manipulation framework such as
      <a data-external="true" href="https://asm.ow2.io/" id="-msity5_88" rel="noopener noreferrer" style="color: red;" target="_blank">
       ASM
      </a>
      .
     </p>
     <p id="-msity5_84">
      You can do this by following these steps:
     </p>
     <ol class="list _decimal" id="-msity5_85" type="1">
      <li class="list__item" id="-msity5_89">
       <p id="-msity5_93">
        Read the bytecode of a
        <code class="code" id="-msity5_94">
         .class
        </code>
        file using the ASM library's
        <code class="code" id="-msity5_95">
         ClassReader
        </code>
        class. This class processes the compiled file and populates a
        <code class="code" id="-msity5_96">
         ClassNode
        </code>
        object, which represents the class structure.
       </p>
      </li>
      <li class="list__item" id="-msity5_90">
       <p id="-msity5_97">
        Extract the
        <code class="code" id="-msity5_98">
         @Metadata
        </code>
        from the
        <code class="code" id="-msity5_99">
         ClassNode
        </code>
        object. The example below uses a custom extension function
        <code class="code" id="-msity5_100">
         findAnnotation()
        </code>
        for this.
       </p>
      </li>
      <li class="list__item" id="-msity5_91">
       <p id="-msity5_101">
        Parse the extracted metadata using the
        <code class="code" id="-msity5_102">
         KotlinClassMetadata.readLenient()
        </code>
        function.
       </p>
      </li>
      <li class="list__item" id="-msity5_92">
       <p id="-msity5_103">
        Inspect the parsed metadata with the
        <code class="code" id="-msity5_104">
         kmClass
        </code>
        and
        <code class="code" id="-msity5_105">
         kmPackage
        </code>
        properties.
       </p>
      </li>
     </ol>
     <p id="-msity5_86">
      Here's an example:
     </p>
     <div class="code-block" data-lang="kotlin" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
      // Imports the necessary libraries
import kotlin.metadata.jvm.*
import kotlin.metadata.*
import org.objectweb.asm.*
import org.objectweb.asm.tree.*
import java.io.File

// Checks if an annotation refers to a specific name
fun AnnotationNode.refersToName(name: String) =
    desc.startsWith('L') &amp;&amp; desc.endsWith(';') &amp;&amp; desc.regionMatches(1, name, 0, name.length)

// Retrieves annotation values by key
private fun List&lt;Any&gt;.annotationValue(key: String): Any? {
    for (index in (0 until size / 2)) {
        if (this[index * 2] == key) {
            return this[index * 2 + 1]
        }
    }
    return null
}

// Defines a custom extension function to locate an annotation by its name in a ClassNode
fun ClassNode.findAnnotation(annotationName: String, includeInvisible: Boolean = false): AnnotationNode? {
    val visible = visibleAnnotations?.firstOrNull { it.refersToName(annotationName) }
    if (!includeInvisible) return visible
    return visible ?: invisibleAnnotations?.firstOrNull { it.refersToName(annotationName) }
}

// Operator to simplify retrieving annotation values
operator fun AnnotationNode.get(key: String): Any? = values.annotationValue(key)

// Extracts Kotlin metadata from a class node
fun ClassNode.readMetadataLenient(): KotlinClassMetadata? {
    val metadataAnnotation = findAnnotation("kotlin/Metadata", false) ?: return null
    @Suppress("UNCHECKED_CAST")
    val metadata = Metadata(
        kind = metadataAnnotation["k"] as Int?,
        metadataVersion = (metadataAnnotation["mv"] as List&lt;Int&gt;?)?.toIntArray(),
        data1 = (metadataAnnotation["d1"] as List&lt;String&gt;?)?.toTypedArray(),
        data2 = (metadataAnnotation["d2"] as List&lt;String&gt;?)?.toTypedArray(),
        extraString = metadataAnnotation["xs"] as String?,
        packageName = metadataAnnotation["pn"] as String?,
        extraInt = metadataAnnotation["xi"] as Int?
    )
    return KotlinClassMetadata.readLenient(metadata)
}

// Converts a file to a ClassNode for bytecode inspection
fun File.toClassNode(): ClassNode {
    val node = ClassNode()
    this.inputStream().use { ClassReader(it).accept(node, ClassReader.SKIP_CODE) }
    return node
}

fun main() {
    val classFilePath = "build/classes/kotlin/main/org/example/SampleClass.class"
    val classFile = File(classFilePath)

    // Reads the bytecode and processes it into a ClassNode object
    val classNode = classFile.toClassNode()

    // Locates the @Metadata annotation and reads it leniently
    val metadata = classNode.readMetadataLenient()
    if (metadata != null &amp;&amp; metadata is KotlinClassMetadata.Class) {
        // Inspects the parsed metadata
        val kmClass = metadata.kmClass

        // Prints class details
        println("Class name: ${kmClass.name}")
        println("Functions:")
        kmClass.functions.forEach { function -&gt;
            println("- ${function.name}, Visibility: ${function.visibility}")
        }
    }
}
     </div>
    </section>
   </section>
   <section class="chapter">
    <h2 data-toc="modify-metadata" id="modify-metadata">
     Modify metadata
    </h2>
    <p id="-msity5_106">
     When using tools like
     <a data-external="true" href="https://github.com/Guardsquare/proguard" id="-msity5_113" rel="noopener noreferrer" style="color: red;" target="_blank">
      ProGuard
     </a>
     to shrink and optimize bytecode, some declarations may be removed from
     <code class="code" id="-msity5_114">
      .class
     </code>
     files. ProGuard automatically updates metadata to keep it consistent with the modified bytecode.
    </p>
    <p id="-msity5_107">
     However, if you're developing a custom tool that modifies Kotlin bytecode in a similar way, you need to ensure that metadata is adjusted accordingly. With the
     <code class="code" id="-msity5_115">
      kotlin-metadata-jvm
     </code>
     library, you can update declarations, adjust attributes, and remove specific elements.
    </p>
    <p id="-msity5_108">
     For example, if you use a JVM tool that deletes private methods from Java class files, you must also delete private functions from Kotlin metadata to maintain consistency:
    </p>
    <ol class="list _decimal" id="-msity5_109" type="1">
     <li class="list__item" id="-msity5_116">
      <p id="-msity5_119">
       Parse the metadata by using the
       <code class="code" id="-msity5_120">
        readStrict()
       </code>
       function to load the
       <code class="code" id="-msity5_121">
        @Metadata
       </code>
       annotation into a structured
       <code class="code" id="-msity5_122">
        KotlinClassMetadata
       </code>
       object.
      </p>
     </li>
     <li class="list__item" id="-msity5_117">
      <p id="-msity5_123">
       Apply modifications by adjusting the metadata, such as filtering functions or altering attributes, directly within
       <code class="code" id="-msity5_124">
        kmClass
       </code>
       or other metadata structures.
      </p>
     </li>
     <li class="list__item" id="-msity5_118">
      <p id="-msity5_125">
       Use the
       <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/kotlin-metadata-jvm/kotlin.metadata.jvm/-kotlin-class-metadata/write.html" id="-msity5_126" rel="noopener noreferrer" style="color: red;" target="_blank">
        <code class="code" id="-msity5_128">
         write()
        </code>
       </a>
       function to encode the modified metadata into a new
       <code class="code" id="-msity5_127">
        @Metadata
       </code>
       annotation.
      </p>
     </li>
    </ol>
    <p id="-msity5_110">
     Here's an example where private functions are removed from a class's metadata:
    </p>
    <div class="code-block" data-lang="kotlin" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
     // Imports the necessary libraries
import kotlin.metadata.jvm.*
import kotlin.metadata.*

fun main() {
    // Specifies the fully qualified class name
    val className = "org.example.SampleClass"

    try {
        // Retrieves the class object for the specified name
        val clazz = Class.forName(className)

        // Retrieves the @Metadata annotation
        val metadataAnnotation = clazz.getAnnotation(Metadata::class.java)
        if (metadataAnnotation != null) {
            println("Kotlin Metadata found for class: $className")

            // Parses metadata using the readStrict() function
            val metadata = KotlinClassMetadata.readStrict(metadataAnnotation)
            if (metadata is KotlinClassMetadata.Class) {
                val kmClass = metadata.kmClass

                // Removes private functions from the class metadata
                kmClass.functions.removeIf { it.visibility == Visibility.PRIVATE }
                println("Removed private functions. Remaining functions: ${kmClass.functions.map { it.name }}")

                // Serializes the modified metadata back
                val newMetadata = metadata.write()
                // After modifying the metadata, you need to write it into the class file
                // To do so, you can use a bytecode manipulation framework such as ASM
                
                println("Modified metadata: ${newMetadata}")
            } else {
                println("The metadata is not a class.")
            }
        } else {
            println("No Kotlin Metadata found for class: $className")
        }
    } catch (e: ClassNotFoundException) {
        println("Class not found: $className")
    } catch (e: Exception) {
        println("Error processing metadata: ${e.message}")
        e.printStackTrace()
    }
}
    </div>
    <aside class="prompt" data-title="" data-type="tip" id="-msity5_112">
     <p id="-msity5_129">
      Instead of separately calling
      <code class="code" id="-msity5_130">
       readStrict()
      </code>
      and
      <code class="code" id="-msity5_131">
       write()
      </code>
      , you can use the
      <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/kotlin-metadata-jvm/kotlin.metadata.jvm/-kotlin-class-metadata/-companion/transform.html" id="-msity5_132" rel="noopener noreferrer" style="color: red;" target="_blank">
       <code class="code" id="-msity5_133">
        transform()
       </code>
      </a>
      function. This function parses metadata, applies transformations through a lambda, and writes the modified metadata automatically.
     </p>
    </aside>
   </section>
   <section class="chapter">
    <h2 data-toc="create-metadata-from-scratch" id="create-metadata-from-scratch">
     Create metadata from scratch
    </h2>
    <p id="-msity5_134">
     To create metadata for a Kotlin class file from scratch using the Kotlin Metadata JVM library:
    </p>
    <ol class="list _decimal" id="-msity5_135" type="1">
     <li class="list__item" id="-msity5_139">
      <p id="-msity5_144">
       Create an instance of
       <code class="code" id="-msity5_145">
        KmClass
       </code>
       ,
       <code class="code" id="-msity5_146">
        KmPackage
       </code>
       , or
       <code class="code" id="-msity5_147">
        KmLambda
       </code>
       , depending on the type of metadata you want to generate.
      </p>
     </li>
     <li class="list__item" id="-msity5_140">
      <p id="-msity5_148">
       Add attributes to the instance, such as the class name, visibility, constructors, and function signatures.
      </p>
      <aside class="prompt" data-title="" data-type="tip" id="-msity5_149">
       <p id="-msity5_151">
        You can use the
        <code class="code" id="-msity5_152">
         apply()
        </code>
        <a data-tooltip="The Kotlin standard library contains several functions whose sole purpose is to execute a block of code within the context of an object. When you call such a function on an object with a lambda expression provided, it forms a temporary scope. In this scope, you can access the objectâ€¦" href="scope-functions.html" id="-msity5_153" style="color: blue;">
         scope function
        </a>
        to reduce boilerplate code while setting properties.
       </p>
      </aside>
      <p id="-msity5_150">
      </p>
     </li>
     <li class="list__item" id="-msity5_141">
      <p id="-msity5_154">
       Use the instance to create a
       <code class="code" id="-msity5_155">
        KotlinClassMetadata
       </code>
       object, which can generate a
       <code class="code" id="-msity5_156">
        @Metadata
       </code>
       annotation.
      </p>
     </li>
     <li class="list__item" id="-msity5_142">
      <p id="-msity5_157">
       Specify the metadata version, such as
       <code class="code" id="-msity5_158">
        JvmMetadataVersion.LATEST_STABLE_SUPPORTED
       </code>
       , and set flags (
       <code class="code" id="-msity5_159">
        0
       </code>
       for no flags, or copy flags from existing files if necessary).
      </p>
     </li>
     <li class="list__item" id="-msity5_143">
      <p id="-msity5_160">
       Use the
       <code class="code" id="-msity5_161">
        ClassWriter
       </code>
       class from
       <a data-external="true" href="https://asm.ow2.io/" id="-msity5_162" rel="noopener noreferrer" style="color: red;" target="_blank">
        ASM
       </a>
       to embed metadata fields, such as
       <code class="code" id="-msity5_163">
        kind
       </code>
       ,
       <code class="code" id="-msity5_164">
        data1
       </code>
       and
       <code class="code" id="-msity5_165">
        data2
       </code>
       into a
       <code class="code" id="-msity5_166">
        .class
       </code>
       file.
      </p>
     </li>
    </ol>
    <p id="-msity5_136">
     The following example demonstrates how to create metadata for a simple Kotlin class:
    </p>
    <div class="code-block" data-lang="kotlin" style="font-family: monospace; background: #f4f4f4; padding: 10px; overflow-x: auto; margin: 1em 0; display: block;">
     // Imports the necessary libraries
import kotlin.metadata.*
import kotlin.metadata.jvm.*
import org.objectweb.asm.*

fun main() {
    // Creates a KmClass instance
    val klass = KmClass().apply {
        name = "Hello"
        visibility = Visibility.PUBLIC
        constructors += KmConstructor().apply {
            visibility = Visibility.PUBLIC
            signature = JvmMethodSignature("&lt;init&gt;", "()V")
        }
        functions += KmFunction("hello").apply {
            visibility = Visibility.PUBLIC
            returnType = KmType().apply {
                classifier = KmClassifier.Class("kotlin/String")
            }
            signature = JvmMethodSignature("hello", "()Ljava/lang/String;")
        }
    }

    // Serializes a KotlinClassMetadata.Class instance, including the version and flags, into a @kotlin.Metadata annotation
    val annotationData = KotlinClassMetadata.Class(
        klass, JvmMetadataVersion.LATEST_STABLE_SUPPORTED, 0
    ).write()

    // Generates a .class file with ASM
    val classBytes = ClassWriter(0).apply {
        visit(Opcodes.V1_6, Opcodes.ACC_PUBLIC, "Hello", null, "java/lang/Object", null)
        // Writes @kotlin.Metadata instance to the .class file
        visitAnnotation("Lkotlin/Metadata;", true).apply {
            visit("mv", annotationData.metadataVersion)
            visit("k", annotationData.kind)
            visitArray("d1").apply {
                annotationData.data1.forEach { visit(null, it) }
                visitEnd()
            }
            visitArray("d2").apply {
                annotationData.data2.forEach { visit(null, it) }
                visitEnd()
            }
            visitEnd()
        }
        visitEnd()
    }.toByteArray()

    // Writes the generated class file to disk
    java.io.File("Hello.class").writeBytes(classBytes)

    println("Metadata and .class file created successfully.")
}
    </div>
    <aside class="prompt" data-title="" data-type="tip" id="-msity5_138">
     <p id="-msity5_167">
      For a more detailed example, see the
      <a data-external="true" href="https://github.com/JetBrains/kotlin/blob/50331fb1496378c82c862db04af597e4198ec645/libraries/kotlinx-metadata/jvm/test/kotlin/metadata/test/MetadataSmokeTest.kt#L43" id="-msity5_168" rel="noopener noreferrer" style="color: red;" target="_blank">
       Kotlin Metadata JVM GitHub repository
      </a>
      .
     </p>
    </aside>
   </section>
   <section class="chapter">
    <h2 data-toc="what-s-next" id="what-s-next">
     What's next
    </h2>
    <ul class="list _bullet" id="-msity5_169">
     <li class="list__item" id="-msity5_170">
      <p id="-msity5_173">
       <a data-external="true" href="https://kotlinlang.org/api/kotlinx-metadata-jvm/" id="-msity5_174" rel="noopener noreferrer" style="color: red;" target="_blank">
        See the API reference for the Kotlin Metadata JVM library
       </a>
       .
      </p>
     </li>
     <li class="list__item" id="-msity5_171">
      <p id="-msity5_175">
       <a data-external="true" href="https://github.com/JetBrains/kotlin/tree/master/libraries/kotlinx-metadata/jvm" id="-msity5_176" rel="noopener noreferrer" style="color: red;" target="_blank">
        Check out the Kotlin Metadata JVM GitHub repository
       </a>
       .
      </p>
     </li>
     <li class="list__item" id="-msity5_172">
      <p id="-msity5_177">
       <a data-external="true" href="https://github.com/JetBrains/kotlin/blob/master/libraries/kotlinx-metadata/jvm/ReadMe.md#module-metadata" id="-msity5_178" rel="noopener noreferrer" style="color: red;" target="_blank">
        Learn about module metadata and working with
        <code class="code" id="-msity5_179">
         .kotlin_module
        </code>
        files
       </a>
       .
      </p>
     </li>
    </ul>
   </section>
   <div class="last-modified">
    19 April 2025
   </div>
   <div data-feedback-placeholder="true">
   </div>
  </article>
 </body>
</html>
